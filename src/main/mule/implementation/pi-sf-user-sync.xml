<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:email="http://www.mulesoft.org/schema/mule/email" xmlns:http="http://www.mulesoft.org/schema/mule/http"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns:salesforce="http://www.mulesoft.org/schema/mule/salesforce" xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/salesforce http://www.mulesoft.org/schema/mule/salesforce/current/mule-salesforce.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/email http://www.mulesoft.org/schema/mule/email/current/mule-email.xsd">
	<sub-flow name="pi-sf-user-sync-sub-flow" doc:id="91c00eb1-3f16-4f86-853f-138c46263bcd" >
		<logger level="INFO" doc:name="Start" doc:id="0121d455-a212-4eae-9781-3bb62b86cc34" message='#[%dw 2.0&#10;output application/json&#10;---&#10;{&#10;	flow: "Start of flow : " ++ flow.name,&#10;	message: "Projects Insights User Sync Started",&#10;	correlationId: vars.correlationId&#10;}]' />
		<flow-ref doc:name="sf-query-sub-flow" doc:id="d8d7f3a3-6c20-4551-8086-5f0d561fe9f7" name="sf-query-sub-flow"/>
		<flow-ref doc:name="sf-user-sync-sub-flow" doc:id="6d2e510d-a4fc-451a-9fa3-35da40c0bcef" name="sf-user-sync-sub-flow"/>
		<flow-ref doc:name="common-email-transformation-sub-flow" doc:id="e7297410-bcbd-4595-9b31-6c5caba7f8cf" name="common-email-transformation-sub-flow"/>
		<ee:transform doc:name="final payload" doc:id="155d7776-c2f6-4c30-9e22-b50fb569a198" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
	"Count of Successful Records" : vars.successfulRecords,
	"Count of Failed Records" : vars.failedRecords
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<logger level="INFO" doc:name="End" doc:id="89b3dde3-a3e7-4c28-9f61-0c8ac4fd3e00" message='#[%dw 2.0&#10;output application/json&#10;---&#10;{&#10;	flow: "End of flow : " ++ flow.name,&#10;	message: "Projects Insights User Sync Ended",&#10;	correlationId: vars.correlationId&#10;}]' />
	</sub-flow>
	<sub-flow name="sf-query-sub-flow" doc:id="c2088ef4-8623-4436-965b-3c672442e138" >
		<logger level="INFO" doc:name="Start" doc:id="74eec6eb-572a-4f16-97ba-8ec6c7d03198" message='#[%dw 2.0&#10;output application/json&#10;---&#10;{&#10;	flow: "Start of flow : " ++ flow.name,&#10;	message: "Salesforce User Query Sync Started",&#10;	correlationId: vars.correlationId&#10;}]' />
		<ee:transform doc:name="var: sfUserQuery" doc:id="1887c578-4e15-4ccf-b597-d9c9897a1130" >
			<ee:message >
			</ee:message>
			<ee:variables >
				<ee:set-variable resource="dwl/v-sfUserQuery.dwl" variableName="sfUserQuery" />
			</ee:variables>
		</ee:transform>
		<salesforce:query doc:name="Salesforce User Query" doc:id="7184f000-6a93-4f7b-bf47-0cb3f23a6e9d" config-ref="salesforce-configuration">
			<reconnect frequency="${reconnection.frequency}" count="${reconnection.attempts}" />
			<salesforce:salesforce-query ><![CDATA[#[vars.sfUserQuery]]]></salesforce:salesforce-query>
		</salesforce:query>
		<ee:transform doc:name="SF User Payload" doc:id="97104290-f046-4866-8f02-37c8f06dd021" >
			<ee:message >
			</ee:message>
			<ee:variables >
				<ee:set-variable variableName="sfResponse" ><![CDATA[%dw 2.0
output application/json
---
payload]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<logger level="INFO" doc:name="End" doc:id="6ce3fca7-b2ac-4717-822e-2d60403646d0" message='#[%dw 2.0&#10;output application/json&#10;---&#10;{&#10;	flow: "End of flow : " ++ flow.name,&#10;	message: "Salesforce User Query Sync Ended",&#10;	correlationId: vars.correlationId&#10;}]' />
	</sub-flow>
	<sub-flow name="sf-user-sync-sub-flow" doc:id="8daa50cd-5f5d-439f-b76c-33013be73963" >
		<logger level="INFO" doc:name="Start" doc:id="9f3179d9-1ab5-4e09-beb4-a1424b1c61f6" message='#[%dw 2.0&#10;output application/json&#10;---&#10;{&#10;	flow: "Start of flow : " ++ flow.name,&#10;	message: "User Retieveal from Project Insights Started",&#10;	correlationId: vars.correlationId&#10;}]' />
		<foreach doc:name="Iteration over SF Query Record" doc:id="09568048-c212-466e-abd0-3e92a8c96426" collection="#[vars.sfResponse]">
			<try doc:name="Try" doc:id="f05918d9-7295-42aa-b386-4a2e1c12e0bb" >
				<ee:transform doc:name="var : httpRequest &amp; sfId" doc:id="05b0fb20-f94f-480b-9144-9cc34d343a77">
				<ee:message />
				<ee:variables>
					<ee:set-variable resource="dwl/v-sfId.dwl" variableName="sfId" />
					<ee:set-variable resource="dwl/v-userHttpRequest.dwl" variableName="httpRequest" />
				</ee:variables>
			</ee:transform>
				<http:request method="#[vars.httpRequest.method]" doc:name="Project Insights Request" doc:id="03ca2c3f-c5f1-4be8-9740-ef26a65a588c" config-ref="project-insights-http-request-configuration" path="#[vars.httpRequest.path]" responseTimeout="${response.timeout}">
				<reconnect frequency="${reconnection.frequency}" count="${reconnection.attempts}" />
				<http:query-params><![CDATA[#[%dw 2.0
output application/json
---
{
	"api-token" : vars.httpRequest.apiToken,
	"emailAddress" : vars.httpRequest.emailAddress
}]]]></http:query-params>
			</http:request>
				<ee:transform doc:name="User Payload" doc:id="3a57143c-59e4-45ac-9d57-3aa30c1a3f20">
				<ee:message>
					<ee:set-payload><![CDATA[%dw 2.0
import fail from dw::Runtime
output application/json
---
if(!isEmpty(payload)) [{
	"Id": vars.sfId,
	"PI_Id__c": payload.Id
}] else fail ("Record failed.")
]]></ee:set-payload>
				</ee:message>
			</ee:transform>
				<salesforce:update doc:name="Update" doc:id="c8d5b51c-2ea4-41c5-8a50-aa8d8840e8ac" config-ref="salesforce-configuration" type="User">
				<reconnect frequency="${reconnection.frequency}" count="${reconnection.attempts}" />
			</salesforce:update>
				<ee:transform doc:name="var : successfulRecords" doc:id="d6f3569b-c695-43de-8732-148c8d8857bf">
					<ee:message>
					</ee:message>
					<ee:variables>
						<ee:set-variable variableName="successfulRecords"><![CDATA[%dw 2.0
output application/json
---
(vars.successfulRecords default []) + vars.sfId]]></ee:set-variable>
					</ee:variables>
				</ee:transform>
				<error-handler >
					<on-error-continue enableNotifications="true" logException="true" doc:name="On Error Continue" doc:id="69e151d0-dc5f-41e6-9083-6d8fe1ab611d" type="ANY">
						<ee:transform doc:name="var : failedRecords" doc:id="13b8ff79-428a-4daa-a74c-4b24ab4ed285" >
							<ee:message >
							</ee:message>
							<ee:variables >
								<ee:set-variable variableName="failedRecords" ><![CDATA[%dw 2.0
output application/json
---
(vars.failedRecords default []) + vars.sfId]]></ee:set-variable>
							</ee:variables>
						</ee:transform>
					</on-error-continue>
				</error-handler>
			</try>
		</foreach>
		<logger level="INFO" doc:name="End" doc:id="a7a522b3-2cd7-4379-966f-38e429e3c0b6" message='#[%dw 2.0&#10;output application/json&#10;---&#10;{&#10;	flow: "End of flow : " ++ flow.name,&#10;	message: "Salesforce User Sync Ended",&#10;	correlationId: vars.correlationId&#10;}]' />
	</sub-flow>
</mule>
